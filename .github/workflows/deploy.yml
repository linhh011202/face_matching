name: Deploy to GKE

on:
   push:
      branches: [main]

env:
   PROJECT_ID: banking-ekyc-487718
   REGION: us-central1
   REPOSITORY: face-matching
   IMAGE_NAME: face-matching
   CLUSTER_NAME: banking-ekyc-cluster

jobs:
   ci:
      name: CI
      uses: ./.github/workflows/ci.yml

   deploy:
      name: Deploy
      runs-on: ubuntu-latest
      needs: ci
      permissions:
         contents: read
         id-token: write

      steps:
         - uses: actions/checkout@v4

         - name: Authenticate to Google Cloud
           uses: google-github-actions/auth@v2
           with:
              workload_identity_provider: projects/884304521920/locations/global/workloadIdentityPools/github-pool/providers/github-provider
              service_account: github-deployer@banking-ekyc-487718.iam.gserviceaccount.com

         - name: Set up Cloud SDK
           uses: google-github-actions/setup-gcloud@v2
           with:
              install_components: "gke-gcloud-auth-plugin"

         - name: Configure Docker for Artifact Registry
           run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

         - name: Create Artifact Registry repository (if not exists)
           run: |
              gcloud artifacts repositories create ${{ env.REPOSITORY }} \
                --repository-format=docker \
                --location=${{ env.REGION }} \
                --project=${{ env.PROJECT_ID }} \
                --quiet 2>/dev/null || true

         - name: Fetch Firebase Credentials from Secret Manager
           run: |
              gcloud secrets versions access latest \
                --secret=firebase-credentials \
                --project=${{ env.PROJECT_ID }} > firebase_credentials.json

         - name: Write config from GitHub Secret
           env:
              CONFIG_CONTENT: ${{ secrets.APPLICATION_CONFIG }}
           run: |
              printf '%s\n' "$CONFIG_CONTENT" > config.yaml

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         - name: Build and Push Image
           uses: docker/build-push-action@v5
           with:
              context: .
              push: true
              tags: |
                 ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                 ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
              # Cache layers in GitHub Actions cache (speeds up TF/model re-builds)
              cache-from: type=gha
              cache-to: type=gha,mode=max

         - name: Deploy to GKE
           run: |
              # Configure kubectl
              gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
                --region ${{ env.REGION }} \
                --project ${{ env.PROJECT_ID }}

              # Create/update K8s secret with config and credentials
              kubectl create secret generic face-matching-secrets \
                --from-file=config.yaml=config.yaml \
                --from-file=firebase_credentials.json=firebase_credentials.json \
                --dry-run=client -o yaml | kubectl apply -f -

              # Get K8s manifests from the GKE config repo
              git clone https://github.com/linhh011202/gke_banking_ekyc.git k8s-config

              # Update the image tag in both deployment manifests
              IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
              sed -i "s|image: .*face-matching.*|image: $IMAGE|g" k8s-config/face-matching-signup-deployment.yaml
              sed -i "s|image: .*face-matching.*|image: $IMAGE|g" k8s-config/face-matching-signin-deployment.yaml

              # Apply both deployments (env vars and tuning are baked into the manifests)
              kubectl apply -f k8s-config/face-matching-signup-deployment.yaml
              kubectl apply -f k8s-config/face-matching-signin-deployment.yaml

              # ── Wait for a GPU node to become Ready before watching rollouts ──
              echo "Waiting for a GPU node (nvidia-tesla-t4) to become Ready..."
              GPU_WAIT=0
              GPU_TIMEOUT=900   # 15 min max for node provisioning
              while true; do
                GPU_NODES=$(kubectl get nodes \
                  -l cloud.google.com/gke-accelerator=nvidia-tesla-t4 \
                  --no-headers 2>/dev/null | grep -c ' Ready' || echo 0)
                if [[ "$GPU_NODES" -gt 0 ]]; then
                  echo "GPU node(s) ready ($GPU_NODES available)."
                  break
                fi
                if [[ "$GPU_WAIT" -ge "$GPU_TIMEOUT" ]]; then
                  echo "WARNING: No GPU node became Ready within ${GPU_TIMEOUT}s. Continuing anyway..."
                  kubectl get nodes -o wide || true
                  break
                fi
                sleep 30
                GPU_WAIT=$((GPU_WAIT + 30))
                echo "  Still waiting for GPU node... (${GPU_WAIT}s / ${GPU_TIMEOUT}s)"
              done

              wait_rollout() {
                local deploy="$1"
                local timeout="$2"

                if kubectl rollout status deployment/"$deploy" --timeout="$timeout"; then
                  return 0
                fi

                echo "Rollout timed out for $deploy. Collecting diagnostics..."
                kubectl get deployment "$deploy" -o wide || true
                kubectl describe deployment "$deploy" || true
                kubectl get pods -o wide || true

                # Force-delete stuck terminating pods, then retry rollout status
                terminating_pods="$(kubectl get pods --no-headers 2>/dev/null | awk '$3 == "Terminating" {print $1}')"
                if [ -n "$terminating_pods" ]; then
                  echo "Force deleting terminating pods: $terminating_pods"
                  for pod in $terminating_pods; do
                    kubectl delete pod "$pod" --grace-period=0 --force || true
                  done
                fi

                kubectl rollout status deployment/"$deploy" --timeout=600s
              }

              # Wait rollouts sequentially (900s = 15 min each, after GPU node is ready)
              wait_rollout face-matching-signup 900s
              wait_rollout face-matching-signin 900s
